# 电子沙漏

# 0 目录

1. 简介
2. 原理图
3. PCB
4. 外壳
5. 物料清单
6. 成本核算
7. 代码实现

# 1 简介

电子沙漏使用STM32F103C8T6作为主控，利用MPU6050感知当前重力方向。

- 支持使用AT指令对运行参数进行配置。
- 支持更换点阵颜色（更换LED8x8点阵屏）。
- 支持Typec接口充电（内置900mAh锂电池）。

![image-20240218105633731](https://raw.githubusercontent.com/MaxDYi/PicGo/main/202402181056795.png)



# 2 原理图

![eHorglass-SCH-V0.0_page-0001](https://raw.githubusercontent.com/MaxDYi/PicGo/main/202402181102905.jpg)

# 3 PCB

![image-20240218110747864](https://raw.githubusercontent.com/MaxDYi/PicGo/main/202402181107907.png)

![image-20240218110751804](https://raw.githubusercontent.com/MaxDYi/PicGo/main/202402181107850.png)

PCB使用4层板设计，面积4.6x9.2cm，主要元器件位于背面，正面仅有LED8x8点阵屏的圆形排母座。

# 4 外壳

外壳设计详见github库中的**4.Component**部分，共设计**外壳-上**与**外壳-上**两部分，使用3D打印进行实现，利用M3铜柱进行连接。

|  元件   |        尺寸        |   体积   |  表面积   |
| :-----: | :----------------: | :------: | :-------: |
| 外壳-上 | 3.2 * 5.2 * 9.8cm  | 17.72cm³ | 245.49cm² |
| 外壳-下 | 3.45 * 5.2 * 9.8cm | 24.72cm³ | 289.86cm² |

# 5 物料清单

| Comment          | Description                 | Designator                                                   | Footprint       | Quantity |
| ---------------- | --------------------------- | ------------------------------------------------------------ | --------------- | -------- |
| 10uF             | 贴片电容/MLCC电容           | C1, C2, C10, C12, C13                                        | C0603_M         | 5        |
| 100nF            | 贴片电容/MLCC电容           | C3, C4, C5, C6, C7,  C8, C9, C11, C14, C15, C16, C17, C18, C19 | C0603_M         | 14       |
| 20pF             | 贴片电容/MLCC电容           | C20, C21                                                     | C0603_M         | 2        |
| 1N5819           | 肖特基二极管                | D1, D2                                                       | SOD-323         | 2        |
| TP4056           | 锂电池充电管理              | IC1                                                          | SOIC-8_EP       | 1        |
| Header 5X2       | 5*2P接插件                  | JP1                                                          | HDR2.54-LI-2x5P | 1        |
| HDR-1X2          | 2P接插件                    | JP2                                                          | XH2.54-LI-2P    | 1        |
| 1588A            | 共阴单色LED8*8点阵屏        | LD1, LD2                                                     | LED 8*8-32-FH   | 2        |
| RED              | 贴片LED                     | LED1, LED3                                                   | LED0603_R       | 2        |
| GREEN            | 贴片LED                     | LED2                                                         | LED0603_G       | 1        |
| AO3401           | P沟道 30V/4.2A              | Q1                                                           | SOT23-3N        | 1        |
| 1K               | 贴片电阻                    | R1, R3, R11                                                  | R0603_M         | 3        |
| 2K               | 贴片电阻                    | R2                                                           | R0603_M         | 1        |
| 10K              | 贴片电阻                    | R4, R9, R10, R14                                             | R0603_M         | 4        |
| 20K              | 贴片电阻                    | R5, R6                                                       | R0603_M         | 2        |
| 5.1K             | 贴片电阻                    | R7, R8                                                       | R0603_M         | 2        |
| 4.7K             | 贴片电阻                    | R12, R13                                                     | R0603_M         | 2        |
| KCD1-101         | 1路单刀船型开关             | S1                                                           | HDR2.54-LI-2P   | 1        |
| M3铜柱           | 铜柱                        | SP1, SP2, SP3, SP4                                           | M3x20+6_N       | 4        |
| 3x6x5            | 3x6轻触开关                 | SW1                                                          | SW SMD-3*6*2.5  | 1        |
| STM32F103C8T6    | STM32 ARM-based  32-bit MCU | U1                                                           | LQFP48_N        | 1        |
| MAX7219          | 8位 LED驱动器               | U2, U3                                                       | SOIC-24W        | 2        |
| MPU6050          | 三轴加速度+三轴陀螺仪       | U4                                                           | QFN24-P50       | 1        |
| HT7533           | LDO线性稳压芯片             | U5                                                           | SOT89_N         | 1        |
| TYPE-C 2.0  -16P | USB2.0_Type-C_16Pin母座     | USBC1                                                        | USB-C-SMD_16P   | 1        |
| 8MHz             | 2脚无源晶振(谐振器）        | X1                                                           | OSC-5032-2P     | 1        |

# 6 成本核算

|   类目   |           型号            | 采购总价 | 采购数量 | 采购单价 | 使用数量 |    小计     |
| :------: | :-----------------------: | :------: | :------: | :------: | :------: | :---------: |
|   PCB    |        四层板1.6mm        | ¥100.44  |    10    | ¥10.0440 |    1     |   ¥10.04    |
|   SMT    |          经济型           | ¥133.06  |    10    | ¥13.3060 |    1     |   ¥13.31    |
|  元器件  |       STM32F103C8T6       |  ¥8.69   |    1     | ¥8.6900  |    1     |    ¥8.69    |
|  元器件  |          MPU6050          | ¥600.00  |    50    | ¥12.0000 |    1     |   ¥12.00    |
|  元器件  |          TP4056X          |  ¥1.15   |    1     | ¥1.1500  |    1     |    ¥1.15    |
|  元器件  |          MAX7219          | ¥261.60  |    40    | ¥6.5400  |    2     |   ¥13.08    |
|  元器件  |         LED点阵屏         |  ¥2.00   |    1     | ¥2.0000  |    2     |    ¥4.00    |
|  元器件  |          8M Xtal          |  ¥1.13   |    1     | ¥1.1300  |    1     |    ¥1.13    |
|  元器件  |           其他            |  ¥60.54  |    10    | ¥6.0540  |    1     |    ¥6.05    |
|   外壳   |       外壳-上（白）       |  ¥9.21   |    1     | ¥9.2100  |    1     |    ¥9.21    |
|   外壳   |       外壳-下（白）       |  ¥12.85  |    1     | ¥12.8500 |    1     |   ¥12.85    |
|   外壳   |   外壳-上（黑）（选配）   |  ¥22.34  |    1     | ¥22.3400 |    0     |    ¥0.00    |
|   外壳   |   外壳-下（黑）（选配）   |  ¥31.17  |    1     | ¥31.1700 |    0     |    ¥0.00    |
|  固定件  |       尼龙柱M3*20+6       |  ¥6.43   |   100    | ¥0.0643  |    4     |    ¥0.26    |
|  固定件  |     尼龙沉头螺丝M3*10     |  ¥5.42   |   100    | ¥0.0542  |    4     |    ¥0.22    |
|  固定件  |        尼龙螺母M3         |  ¥5.00   |   100    | ¥0.0500  |    4     |    ¥0.20    |
|  锂电池  |     900mAh单节锂电池      |  ¥11.00  |    1     | ¥11.0000 |    1     |   ¥11.00    |
|  锂电池  | 1800mAh单节锂电池（选配） |  ¥18.80  |    1     | ¥18.8000 |    0     |    ¥0.00    |
| **合计** |                           |          |          |          |          | **¥103.19** |

# 7 代码实现

## 7.1 软件环境

IAR 9.30

STM32CubeMX 6.5.0

## 7.2 主要库

使用到的库位于**\eHorglass\Drivers**路径下。

| 库        | 功能                 |
| --------- | -------------------- |
| AT        | AT指令控制与应答     |
| MAX7219   | 点阵屏驱动库         |
| MPU6050   | MPU6050陀螺仪驱动    |
| parameter | 运行参数配置库       |
| Runtime   | 获取代码段运行时间   |
| SandMove  | 砂砾运动控制核心算法 |

## 7.3 砂砾运动控制核心算法

TODO

## 7.4 Flash使用

STM32F103C8T6共128KB内部FLASH，分为128个Page，每Page为1KB。

![image-20240218112618059](https://raw.githubusercontent.com/MaxDYi/PicGo/main/202402181126115.png)

使用前127个FLASH烧录App，最后一个FLash用于记录参数。

|   用途    |          地址           | 大小  |
| :-------: | :---------------------: | :---: |
|    App    | 0x08000000 - 0x0801FBFF | 127KB |
| Parameter | 0x0801FC00 - 0x0801FFFF |  1KB  |

最后一个FLash区域记录的参数表如下：

|    参数     | 字节数 |  格式  |       备注        |
| :---------: | :----: | :----: | :---------------: |
|  initFlag   |   4    | uint32 |    初始化标志     |
|   sandNum   |   4    | uint32 |     砂砾个数      |
|  frameTime  |   4    | uint32 |    显示帧间隔     |
| angleOffset |   4    | float  | MPU6050角度校准值 |

